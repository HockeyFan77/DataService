@page "/dbobjects"
@using System.Threading
@using System.Web
@inject IDataService Api
@inject NavigationManager Nav

@using MudBlazor

<MudPaper Class="pa-4">

  <MudText Typo="Typo.h5" Class="mb-2">Database Objects</MudText>

  <MudGrid>
    <MudItem xs="12" sm="1">
      <MudTextField Label="Search Context" @bind-Value="SearchContext" Placeholder="e.g., dev, int, prod" />
    </MudItem>

    <MudItem xs="12" sm="1">
      <MudTextField Label="Databases (Aliases)" @bind-Value="DatabaseSearch" Placeholder="e.g., prs;d;il" />
    </MudItem>

    <MudItem xs="12" sm="1">
      <MudTextField Label="Schema" @bind-Value="SchemaSearch" Immediate="false" Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Search" />
    </MudItem>

    <MudItem xs="12" sm="4">
      <MudTextField Label="Name" @bind-Value="NameSearch" Immediate="false" Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Search" />
    </MudItem>

    <MudItem xs="12" sm="1">
      <MudTextField Label="Object Types" @bind-Value="TypeSearch" Placeholder="e.g., F;G;P;T;V" />
    </MudItem>

    <MudItem xs="12" sm="4" Class="d-flex align-center">
      <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="@(!HasSearchParameters)" OnClick="ApplyFilters">Search</MudButton>
      <MudSpacer />
      <MudButton Variant="Variant.Outlined" Color="Color.Default" OnClick="ClearFilters">Clear</MudButton>
    </MudItem>
  </MudGrid>

  <MudDivider Class="my-3" />

  @if (isLoading)
  {
    <MudProgressLinear Indeterminate="true" />
  }

  <MudTable Items="displayItems" Dense="true" Hover="true" Bordered="true"
    RowsPerPage="rowsPerPage" RowsPerPageOptions="rowsPerPageOptions">

    <HeaderContent>
      <MudTh SortBy="(Func<DatabaseObjectsListItemDto, object>)(x => x.Database)">Database</MudTh>
      <MudTh SortBy="(Func<DatabaseObjectsListItemDto, object>)(x => x.Schema)">Schema</MudTh>
      <MudTh SortBy="(Func<DatabaseObjectsListItemDto, object>)(x => x.Name)">Name</MudTh>
      <MudTh SortBy="(Func<DatabaseObjectsListItemDto, object>)(x => x.Type)">Type</MudTh>
      <MudTh>Created</MudTh>
      <MudTh>Modified</MudTh>
    </HeaderContent>

    <RowTemplate>
      <MudTd>@context.Database</MudTd>
      <MudTd>@context.Schema</MudTd>
      <MudTd>
        @context.Name
        <MudLink Href="@BuildObjectDetailsLink(context)" Target="_blank" Class="ml-2">
          <MudIcon Color="Color.Primary" Icon="@Icons.Material.Filled.Info" Title="Details" />
        </MudLink>
      </MudTd>
      <MudTd>@context.Type</MudTd>
      <MudTd>@context.Created?.ToString("yyyy-MM-dd HH:mm")</MudTd>
      <MudTd>@context.Modified?.ToString("yyyy-MM-dd HH:mm")</MudTd>
    </RowTemplate>

    <PagerContent>
      <MudTablePager />
    </PagerContent>
  </MudTable>

</MudPaper>

@code {

  // Query-bound parameters stored in URL
  [Parameter]
  [SupplyParameterFromQuery(Name = "ctx")]
  public string? SearchContext { get; set; }

  [Parameter]
  [SupplyParameterFromQuery(Name = "dbaliases")]
  public string? DatabaseSearch { get; set; }

  [Parameter]
  [SupplyParameterFromQuery(Name = "objsch")]
  public string? SchemaSearch { get; set; }

  [Parameter]
  [SupplyParameterFromQuery(Name = "objname")]
  public string? NameSearch { get; set; }

  [Parameter]
  [SupplyParameterFromQuery(Name = "objtypes")]
  public string? TypeSearch { get; set; }

  private bool HasSearchParameters =>
    !string.IsNullOrWhiteSpace(SearchContext) ||
    !string.IsNullOrWhiteSpace(DatabaseSearch) ||
    !string.IsNullOrWhiteSpace(SchemaSearch) ||
    !string.IsNullOrWhiteSpace(NameSearch) ||
    !string.IsNullOrWhiteSpace(TypeSearch);
  private bool isLoading;
  private List<DatabaseObjectsListItemDto> rawItems = new();
  private IEnumerable<DatabaseObjectsListItemDto> displayItems => ApplyInMemorySortAndFilter();

  // Paging (client-side)
  private int rowsPerPage = 100;
  private int[] rowsPerPageOptions = new int[] { 10, 20, 50, 100 };

  protected override async Task OnInitializedAsync()
  {
    // Load initial state from URL automatically when component is navigated to
    await LoadDataAsync();
  }

  // When URL query params changed (e.g., user pasted link), ensure we reload
  protected override async Task OnParametersSetAsync()
  {
    // If filter parameters changed externally, reload
    await LoadDataAsync();
  }

  private void ApplyFilters()
  {
    // Update the URL with new query params (replace so back button behaviour is sane)
    var uri = new Uri(Nav.Uri);
    var baseUri = uri.GetLeftPart(UriPartial.Path);

    var parameters = new Dictionary<string, string?>()
    {
      ["ctx"] = string.IsNullOrWhiteSpace(SearchContext) ? null : SearchContext,
      ["dbaliases"] = string.IsNullOrWhiteSpace(DatabaseSearch) ? null : DatabaseSearch,
      ["objsch"] = string.IsNullOrWhiteSpace(SchemaSearch) ? null : SchemaSearch,
      ["objname"] = string.IsNullOrWhiteSpace(NameSearch) ? null : NameSearch,
      ["objtypes"] = string.IsNullOrWhiteSpace(TypeSearch) ? null : TypeSearch
    };

    var qs = string.Join("&", parameters
      .Where(kv => !string.IsNullOrWhiteSpace(kv.Value))
      .Select(kv => $"{Uri.EscapeDataString(kv.Key)}={Uri.EscapeDataString(kv.Value!)}"));

    var newUrl = string.IsNullOrEmpty(qs) ? baseUri : $"{baseUri}?{qs}";
    Nav.NavigateTo(newUrl, replace: true);
    // OnParametersSetAsync will run and call LoadDataAsync
  }

  private void ClearFilters()
  {
    SearchContext = null;
    DatabaseSearch = null;
    SchemaSearch = null;
    NameSearch = null;
    TypeSearch = null;
    ApplyFilters();
  }

  private async Task LoadDataAsync()
  {
    if ( !HasSearchParameters )
    {
      rawItems = new();
      return;
    }

    isLoading = true;
    try
    {
      // For now request a large pagesize to get all rows in a single call
      // (alternatively, make pagesize == the page size returned by your API)
      var resp = await Api.GetDatabaseObjectsAsync(
        SearchContext!,
        new DatabaseObjectsListRequestDto
        {
          DatabaseSearch = this.DatabaseSearch,
          SchemaSearch = this.SchemaSearch,
          NameSearch = this.NameSearch,
          TypeSearch = this.TypeSearch,
          Page = 1,
          PageSize = 5000
        });

      rawItems = resp?.Objects ?? new();
    }
    finally
    {
      isLoading = false;
      StateHasChanged();
    }
  }

  // Apply client-side filtering (again) and sorting - used by the table Items
  private IEnumerable<DatabaseObjectsListItemDto> ApplyInMemorySortAndFilter()
  {
    // Start with raw API results
    IEnumerable<DatabaseObjectsListItemDto> q = rawItems;

    // Additional client-side filter if desired (e.g., local text filter)
    if ( !string.IsNullOrWhiteSpace(DatabaseSearch) )
    {
      q = q.Where(x => x.Database?.Contains(DatabaseSearch, StringComparison.OrdinalIgnoreCase) == true);
    }

    if ( !string.IsNullOrWhiteSpace(SchemaSearch) )
    {
      q = q.Where(x => x.Schema?.Contains(SchemaSearch, StringComparison.OrdinalIgnoreCase) == true);
    }

    if ( !string.IsNullOrWhiteSpace(NameSearch) )
    {
      q = q.Where(x => x.Name?.Contains(NameSearch, StringComparison.OrdinalIgnoreCase) == true);
    }

    if ( !string.IsNullOrWhiteSpace(TypeSearch) )
    {
      q = q.Where(x => x.Type?.Contains(TypeSearch, StringComparison.OrdinalIgnoreCase) == true);
    }

    // NOTE: Sorting by column is handled by MudTable automatically using the SortBy expressions on MudTh
    // Because we pass Items (not ServerData) MudTable will sort/paginate the list client-side.
    return q;
  }

  private string BuildObjectDetailsLink(DatabaseObjectsListItemDto dto)
  {
    var parameters = new Dictionary<string, string?>()
    {
      ["ctx"] = string.IsNullOrWhiteSpace(SearchContext) ? null : SearchContext,
      ["dbname"] = string.IsNullOrWhiteSpace(dto.Database) ? null : dto.Database,
      ["objid"] = dto.Id.ToString()
      //["dbname"] = string.IsNullOrWhiteSpace(dto.Database) ? null : dto.Database,
      //["objsch"] = string.IsNullOrWhiteSpace(dto.Schema) ? null : dto.Schema,
      //["objname"] = string.IsNullOrWhiteSpace(dto.Name) ? null : dto.Name
    };

    var qs = string.Join("&", parameters
      .Where(kv => !string.IsNullOrWhiteSpace(kv.Value))
      .Select(kv => $"{Uri.EscapeDataString(kv.Key)}={Uri.EscapeDataString(kv.Value!)}"));

    return $"/dbobject?{qs}";
  }
}
